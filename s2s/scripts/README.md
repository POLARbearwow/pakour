# Parkouræœºå™¨äººè„šæœ¬ä½¿ç”¨æŒ‡å—

æœ¬ç›®å½•åŒ…å«ä¸¤ä¸ªä¸»è¦è„šæœ¬ï¼Œç”¨äºParkouræœºå™¨äººçš„ä»¿çœŸå’Œæ§åˆ¶ã€‚

## ğŸ“ è„šæœ¬è¯´æ˜

### 1. `visualize_raycaster.py` - åŸºç¡€å¯è§†åŒ–è„šæœ¬

**åŠŸèƒ½ï¼š**
- âœ… Raycasteræ·±åº¦ç›¸æœºå¯è§†åŒ–
- âœ… 3Dåœºæ™¯æ˜¾ç¤ºï¼ˆæœºå™¨äººã€åœ°å½¢ã€å°„çº¿ï¼‰
- âœ… ä¼ æ„Ÿå™¨æ•°æ®è¯Šæ–­

**ä½¿ç”¨åœºæ™¯ï¼š**
- æµ‹è¯•raycasteré…ç½®
- éªŒè¯ç›¸æœºå®‰è£…ä½ç½®
- æ£€æŸ¥å°„çº¿å¯è§†åŒ–æ•ˆæœ

**è¿è¡Œæ–¹å¼ï¼š**
```bash
python s2s/scripts/visualize_raycaster.py
```

**æ— éœ€é¢å¤–å‚æ•°**ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- åŠ è½½raycasteræ’ä»¶
- åˆå§‹åŒ–ä¼ æ„Ÿå™¨
- æ˜¾ç¤º3Dåœºæ™¯å’Œå°„çº¿

---

### 2. `parkour_with_policy.py` - å®Œæ•´æ§åˆ¶è„šæœ¬

**åŠŸèƒ½ï¼š**
- âœ… Raycasteræ·±åº¦ç›¸æœºå¯è§†åŒ–
- âœ… Joystickæ‰‹æŸ„æ§åˆ¶
- âœ… ONNXç­–ç•¥æ¨ç†ï¼ˆå¯é€‰ï¼‰
- âœ… PDæ§åˆ¶ä¿æŒç«™ç«‹
- âœ… å®æ—¶çŠ¶æ€æ˜¾ç¤º

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç”¨æ‰‹æŸ„æ§åˆ¶æœºå™¨äººè¡Œèµ°
- è¿è¡Œè®­ç»ƒå¥½çš„ç­–ç•¥æ¨¡å‹
- åœ¨Parkouråœ°å½¢ä¸Šæµ‹è¯•

**è¿è¡Œæ–¹å¼ï¼š**

#### æ–¹å¼1: ä»…PDæ§åˆ¶ + æ‰‹æŸ„ï¼ˆæ— éœ€æ¨¡å‹ï¼‰
```bash
python s2s/scripts/parkour_with_policy.py
```

#### æ–¹å¼2: ç­–ç•¥æ§åˆ¶ + æ‰‹æŸ„ï¼ˆéœ€è¦ONNXæ¨¡å‹ï¼‰
```bash
python s2s/scripts/parkour_with_policy.py --load_model /path/to/your/model.onnx
```

#### æ–¹å¼3: å¿…é¡»ä½¿ç”¨ç­–ç•¥æ¨¡å‹ï¼ˆæ²¡æœ‰æ¨¡å‹æ—¶é€€å‡ºï¼‰
```bash
python s2s/scripts/parkour_with_policy.py --load_model /path/to/model.onnx --require_model
```

---

## ğŸ® æ‰‹æŸ„æ§åˆ¶è¯´æ˜

**æ”¯æŒçš„æ‰‹æŸ„ï¼š** Xbox / PlayStation / é€šç”¨USBæ‰‹æŸ„

**æ§åˆ¶æ˜ å°„ï¼š**
- **å·¦æ‘‡æ†ä¸Šä¸‹**ï¼šå‰è¿›/åé€€ (é€Ÿåº¦ä¸Šé™: 2.0 m/s)
- **å·¦æ‘‡æ†å·¦å³**ï¼šå·¦å³å¹³ç§» (é€Ÿåº¦ä¸Šé™: 1.0 m/s)
- **å³æ‘‡æ†å·¦å³**ï¼šåŸåœ°æ—‹è½¬ (é€Ÿåº¦ä¸Šé™: 1.5 rad/s)

**æ‰‹æŸ„è®¾å¤‡è·¯å¾„ï¼š** `/dev/input/js0`

**å¦‚æœæ²¡æœ‰æ‰‹æŸ„ï¼š**
è„šæœ¬ä¼šæç¤º"å°†ä»¥é”®ç›˜æ¨¡å¼è¿è¡Œ"ï¼Œä½†ä»å¯ä»¥æŸ¥çœ‹å¯è§†åŒ–æ•ˆæœã€‚

---

## ğŸ–¥ï¸ Vieweræ“ä½œæŒ‡å—

**é¼ æ ‡æ§åˆ¶ï¼š**
- **å·¦é”®åŒå‡»**ï¼šé€‰æ‹©/è·Ÿè¸ªç‰©ä½“
- **å³é”®æ‹–åŠ¨**ï¼šå¹³ç§»è§†è§’
- **Ctrl + å³é”®æ‹–åŠ¨**ï¼šæ—‹è½¬è§†è§’
- **æ»šè½®**ï¼šç¼©æ”¾

**é”®ç›˜å¿«æ·é”®ï¼š**
- **Tab**ï¼šæ‰“å¼€/å…³é—­GUIé¢æ¿
  - åœ¨GUIä¸­å¯ä»¥æŸ¥çœ‹æ¸²æŸ“é€‰é¡¹
  - æ£€æŸ¥ `Geoms -> Group 1/2` ç¡®ä¿å°„çº¿å¯è§

---

## ğŸ¯ Raycasterå¯è§†åŒ–æ•ˆæœ

**çº¢è‰²å°„çº¿ï¼š** ä»ç›¸æœºå‘å‡ºçš„æ·±åº¦æ‰«æå°„çº¿  
**çº¢è‰²/ç»¿è‰²çƒä½“ï¼š** å°„çº¿å‡»ä¸­åœ°å½¢çš„ä½ç½®ï¼ˆå‘½ä¸­ç‚¹ï¼‰

**é…ç½®è°ƒæ•´ï¼ˆåœ¨XMLä¸­ï¼‰ï¼š**
```xml
<!-- å°„çº¿å¯è§†åŒ– -->
<config key="draw_deep_ray" value="1 5 1 1 0.2 0.5 1" />
<!-- å‚æ•°: å¯ç”¨ é—´éš” ç»„ID R G B é€æ˜åº¦ -->

<!-- å‘½ä¸­ç‚¹å¯è§†åŒ– -->
<config key="draw_hip_point" value="1 0.01" />
<!-- å‚æ•°: å¯ç”¨ åŠå¾„ -->
```

**é—´éš”è¯´æ˜ï¼š**
- `1`ï¼šæ˜¾ç¤ºå…¨éƒ¨å°„çº¿
- `2`ï¼šæ¯éš”2æ¡æ˜¾ç¤ºä¸€æ¡
- `5`ï¼šæ¯éš”5æ¡æ˜¾ç¤ºä¸€æ¡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

---

## ğŸ“Š å®æ—¶ä¿¡æ¯æ˜¾ç¤º

è¿è¡Œæ—¶ä¼šåœ¨ç»ˆç«¯æ˜¾ç¤ºï¼š

```
[ç­–ç•¥] æŒ‡ä»¤: x=+1.50 y=-0.30 yaw=+0.50 | é€Ÿåº¦: x=+1.23 y=-0.25 z=+0.02 | æ¥è§¦[LF,LR,RF,RR]: âœ“âœ“âœ—âœ—
```

- **æ¨¡å¼**: `[ç­–ç•¥]` æˆ– `[PD]`
- **æŒ‡ä»¤**: æ‰‹æŸ„è¾“å…¥çš„ç›®æ ‡é€Ÿåº¦
- **é€Ÿåº¦**: æœºå™¨äººå®é™…é€Ÿåº¦ï¼ˆæœ¬ä½“åæ ‡ç³»ï¼‰
- **æ¥è§¦**: å››æ¡è…¿çš„æ¥è§¦çŠ¶æ€
  - `âœ“` = æ¥è§¦åœ°é¢ï¼ˆcontact_force = 0.5ï¼‰
  - `âœ—` = æœªæ¥è§¦ï¼ˆcontact_force = -0.5ï¼‰
  - é¡ºåºï¼šå·¦å‰(LF)ã€å·¦å(LR)ã€å³å‰(RF)ã€å³å(RR)

### Contact Forceæ ¼å¼è¯´æ˜

è„šæœ¬ä¸­çš„contact forceå¤„ç†ä¸Isaac Labå®Œå…¨ä¸€è‡´ï¼š
```python
# Isaac Labæ ¼å¼: (contact_filt.float() - 0.5)
# æ¥è§¦æ—¶: 1.0 - 0.5 = 0.5
# ä¸æ¥è§¦æ—¶: 0.0 - 0.5 = -0.5
```

### Depth Imageå¤„ç†æµç¨‹

æ·±åº¦å›¾åƒå¤„ç†å®Œå…¨æ¨¡æ‹ŸIsaac Labçš„`image_features`å¤„ç†ï¼š

```python
# 1. è£å‰ª (Crop): ç§»é™¤åº•éƒ¨2è¡Œå’Œå·¦å³å„4åˆ—
cropped = depth_image[:-2, 4:-4]  # (60, 106) -> (58, 98)

# 2. ä¸‹é‡‡æ · (Resize): bicubicæ’å€¼åˆ°58Ã—87
resized = cv2.resize(cropped, (87, 58), interpolation=cv2.INTER_CUBIC)

# 3. å½’ä¸€åŒ– (Normalize)
normalized = (resized / 2.0) - 0.5  # clipping_range=2.0

# 4. ç¼“å­˜ (Buffer): æ»‘åŠ¨çª—å£ä¿ç•™3å¸§
# è¾“å‡ºç»´åº¦: 3 Ã— 58 Ã— 87 = 15,138
```

**æ›´æ–°é¢‘ç‡ï¼š** æ¯5ä¸ªç‰©ç†æ­¥æ›´æ–°ä¸€æ¬¡depth bufferï¼ˆä¸Isaac Labä¸€è‡´ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
# åœ¨ç­–ç•¥æ¨ç†ä¸­ä½¿ç”¨æ·±åº¦å›¾åƒ
if depth_processor is not None:
    depth_obs = depth_processor.get_depth_observation()  # 15,138ç»´
    # å¯ä»¥å°†depth_obsæ·»åŠ åˆ°ç­–ç•¥ç½‘ç»œçš„è¾“å…¥ä¸­
```

**æµ‹è¯•æ·±åº¦å›¾åƒå¤„ç†ï¼š**
```bash
python s2s/scripts/test_depth_processing.py
```

è¿™ç¡®ä¿äº†MuJoCoä»¿çœŸä¸Isaac Labè®­ç»ƒç¯å¢ƒçš„å®Œå…¨ä¸€è‡´æ€§ã€‚

---

## âš™ï¸ ä¾èµ–å®‰è£…

### å¿…éœ€ä¾èµ–
```bash
pip install mujoco
pip install mujoco-python-viewer
pip install numpy
pip install scipy
```

### å¯é€‰ä¾èµ–

**ç­–ç•¥æ¨ç†ï¼š**
```bash
pip install onnxruntime
```

**æ·±åº¦å›¾åƒå¤„ç†ï¼š**
```bash
pip install opencv-python
```

> æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£…opencv-pythonï¼Œæ·±åº¦å›¾åƒå¤„ç†å°†è¢«è·³è¿‡ï¼Œä½†å…¶ä»–åŠŸèƒ½ä»å¯æ­£å¸¸è¿è¡Œã€‚

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: çœ‹ä¸åˆ°çº¢è‰²å°„çº¿ï¼Ÿ
**è§£å†³æ–¹æ¡ˆï¼š**
1. æŒ‰ `Tab` æ‰“å¼€GUI
2. æ£€æŸ¥ `Geoms -> Group 1` å’Œ `Group 2` æ˜¯å¦å¯ç”¨
3. è°ƒæ•´ç›¸æœºè§†è§’åˆ°æœºå™¨äººå‰æ–¹
4. ç­‰å¾…å‡ ç§’è®©ä»¿çœŸåˆå§‹åŒ–

### Q2: æ‰‹æŸ„ä¸å“åº”ï¼Ÿ
**æ£€æŸ¥ï¼š**
```bash
ls /dev/input/js*
# åº”è¯¥çœ‹åˆ° /dev/input/js0

# æµ‹è¯•æ‰‹æŸ„
jstest /dev/input/js0
```

### Q3: Raycasteræ’ä»¶åŠ è½½å¤±è´¥ï¼Ÿ
**ç¡®è®¤ï¼š**
- åœ¨raycaster condaç¯å¢ƒä¸­è¿è¡Œ
- æ’ä»¶è·¯å¾„æ­£ç¡®ï¼š`/home/ares/mujoco_ray_caster/lib/libsensor_ray.so`

### Q4: ONNXæ¨¡å‹åŠ è½½å¤±è´¥ï¼Ÿ
**æ£€æŸ¥ï¼š**
- æ¨¡å‹æ–‡ä»¶è·¯å¾„æ­£ç¡®
- onnxruntimeå·²å®‰è£…
- æ¨¡å‹è¾“å…¥ç»´åº¦åŒ¹é…ï¼ˆ450ç»´ = 45 Ã— 10å¸§ï¼‰

---

## ğŸ“ å‚æ•°è¯´æ˜

### PolicyConfig ä¸»è¦é…ç½®

```python
class PolicyConfig:
    class sim_config:
        dt = 0.005           # ä»¿çœŸæ—¶é—´æ­¥ (200Hz)
        decimation = 4       # ç­–ç•¥é¢‘ç‡ (50Hz = 200Hz / 4)
    
    class robot_config:
        kps = 25.0           # PDæ§åˆ¶æ¯”ä¾‹å¢ç›Š
        kds = 0.5            # PDæ§åˆ¶å¾®åˆ†å¢ç›Š
        tau_limit = [17,17,25]*4  # æ‰­çŸ©é™åˆ¶
    
    class control:
        action_scale = 0.25  # åŠ¨ä½œç¼©æ”¾ç³»æ•°
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ç¤ºä¾‹

### ç¤ºä¾‹1: æµ‹è¯•raycaster
```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate raycaster

# 2. è¿è¡Œå¯è§†åŒ–
python s2s/scripts/visualize_raycaster.py

# 3. è§‚å¯Ÿçº¢è‰²å°„çº¿æ‰«æåœ°å½¢
```

### ç¤ºä¾‹2: æ‰‹æŸ„æ§åˆ¶ï¼ˆæ— ç­–ç•¥ï¼‰
```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate raycaster

# 2. è¿æ¥æ‰‹æŸ„å¹¶è¿è¡Œ
python s2s/scripts/parkour_with_policy.py

# 3. ä½¿ç”¨å·¦æ‘‡æ†æ§åˆ¶ç§»åŠ¨
```

### ç¤ºä¾‹3: ç­–ç•¥æ§åˆ¶
```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate raycaster

# 2. è¿è¡Œç­–ç•¥
python s2s/scripts/parkour_with_policy.py \
    --load_model /path/to/your/student_policy.onnx

# 3. ç”¨æ‰‹æŸ„æ§åˆ¶ç­–ç•¥ç½‘ç»œ
```

---

## ğŸ“„ æ–‡ä»¶æ¸…å•

```
s2s/scripts/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ visualize_raycaster.py       # åŸºç¡€å¯è§†åŒ–è„šæœ¬
â””â”€â”€ parkour_with_policy.py       # å®Œæ•´æ§åˆ¶è„šæœ¬

s2s/
â”œâ”€â”€ robot_parkour_with_raycaster.xml  # æœºå™¨äººæ¨¡å‹ï¼ˆå«raycasterï¼‰
â””â”€â”€ reference/                        # å‚è€ƒä»£ç 
    â”œâ”€â”€ joystick_interface.py
    â”œâ”€â”€ s2s_trot_joystick.py
    â””â”€â”€ sensor_data_viewer.py
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç»ˆç«¯è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
2. raycasteræ’ä»¶æ˜¯å¦æ­£å¸¸åŠ è½½
3. æ‰‹æŸ„è®¾å¤‡æ˜¯å¦è¿æ¥
4. ONNXæ¨¡å‹æ˜¯å¦åŒ¹é…

---

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
